# io.enpass.Enpass.yaml
app-id: io.enpass.Enpass
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: enpass
tags: [proprietary]
separate-locales: false
finish-args:
    # X11 + XShm access
  - --share=ipc
  - --socket=x11
    # Notification access
  - --talk-name=org.freedesktop.Notifications
    # System Tray Icon (Test at every major update)
  - --talk-name=com.kde.StatusNotifierWatcher
    # Secret Service
  - --own-name=org.freedesktop.secrets
    # Favicon download
  - --share=network
    # SSH Agent access
  - --socket=ssh-auth
    # Required to save vaults in default location <$HOME/Documents>
  - --filesystem=xdg-documents
modules:
  - name: enpass
    buildsystem: simple
    build-commands:
      - |
        FLATPAK_ID=io.enpass.Enpass

        mkdir -p ${FLATPAK_DEST}/bin/extra
        mkdir -p ${FLATPAK_DEST}/share/app-info/icons/flatpak/{128x128,256x256}
        mkdir -p ${FLATPAK_DEST}/share/mime/packages

        install -Dm 755 apply_extra --target-directory ${FLATPAK_DEST}/bin/
        chmod +x ${FLATPAK_DEST}/bin/apply_extra

        install -Dm 755 enpass --target-directory ${FLATPAK_DEST}/bin/
        chmod +x ${FLATPAK_DEST}/bin/enpass

        install -Dm 644 ${FLATPAK_ID}.desktop --target-directory ${FLATPAK_DEST}/share/applications/
        install -Dm 644 ${FLATPAK_ID}.metainfo.xml --target-directory ${FLATPAK_DEST}/share/metainfo/
        install -Dm 644 mime.xml ${FLATPAK_DEST}/share/mime/packages/${FLATPAK_ID}.xml

        install -Dm 644 ${FLATPAK_ID}.png --target-directory ${FLATPAK_DEST}/share/app-info/icons/flatpak/{128x128,256x256}/
        install -Dm 644 ${FLATPAK_ID}.png --target-directory ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/
        install -Dm 644 ${FLATPAK_ID}.svg --target-directory ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/
    sources:
      - type: script
        dest-filename: enpass
        commands:
          - exec /app/extra/enpass/Enpass
      - type: extra-data
        filename: enpass.deb
        only-arches: [x86_64]
        url: https://apt.enpass.io/pool/main/e/enpass/enpass_6.8.5.1173_amd64.deb
        sha256: 5855e617041d73682320f3643eb4136c93eef2beaf3be9d37cbadfc76d719b5b
        x-checker-data:
          type: debian-repo
          package-name: enpass
          root: https://apt.enpass.io
          dist: stable
          component: main
        size: 39644988
      - type: script
        dest-filename: apply_extra
        commands:
          - |
            FLATPAK_ID=io.enpass.Enpass

            # Extract upstream package
            mkdir -p deb-package export/{bin,share/{applications,icons}}

            bsdtar -xvf enpass.deb
            tar -xzf data.tar.gz -C deb-package

            # Install desktop entry and icons
            mv deb-package/usr/share/{applications,icons} export/share/

            # Remove original `.desktop` file
            rm export/share/applications/enpass.desktop

            # Rename all icons accordingly
            rename enpass ${FLATPAK_ID} export/share/icons/hicolor/*/{apps,status}/*

            # Install the app
            mv deb-package/opt/enpass ./

            ln -s ${FLATPAK_DEST}/extra/enpass/Enpass export/bin/enpass
            chmod +x export/bin/enpass

            # Cleanup
            rm -rf control.tar.gz data.tar.gz debian-binary deb-package enpass.deb
      - type: file
        path: io.enpass.Enpass.metainfo.xml
      - type: file
        path: icons/io.enpass.Enpass.png
      - type: file
        path: icons/io.enpass.Enpass.svg
      - type: file
        path: mime/packages/io.enpass.Enpass.xml
      - type: file
        path: io.enpass.Enpass.desktop
    cleanup:
     - rm -rf app
