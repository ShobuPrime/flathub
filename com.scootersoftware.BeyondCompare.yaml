# com.scootersoftware.BeyondCompare.yaml
app-id: com.scootersoftware.BeyondCompare
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: bcompare
tags: [proprietary]
separate-locales: false
finish-args:
    # X11 + XShm access
  - --share=ipc
  - --socket=x11
    # Notification access
  - --talk-name=org.freedesktop.Notifications
    # System Tray Icon
  - --talk-name=com.kde.StatusNotifierWatcher
    # Used for comparing againt a network share
  - --share=network
    # Required to being comparing documents in users' home directory
  - --filesystem=home
modules:
  - name: bcompare
    buildsystem: simple
    build-commands:
      - |
        # Install scripts
        install -Dm 755 apply_extra --target-directory ${FLATPAK_DEST}/bin/
        install -Dm 755 bcompare --target-directory ${FLATPAK_DEST}/bin/

        # Install Desktop, MetaInfo, and MIME
        install -Dm 644 ${FLATPAK_ID}.desktop --target-directory ${FLATPAK_DEST}/share/applications/
        install -Dm 644 ${FLATPAK_ID}.metainfo.xml --target-directory ${FLATPAK_DEST}/share/metainfo/
        install -Dm 644 ${FLATPAK_ID}.mime.xml --target-directory ${FLATPAK_DEST}/share/mime/packages/

        # Install icons
        install -Dm 644 ${FLATPAK_ID}.png --target-directory ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/
    sources:
      - type: script
        dest-filename: bcompare
        commands:
          - exec /app/extra/bin/bcompare "$@"
      - type: extra-data
        filename: bcompare.deb
        only-arches: [x86_64]
        url: https://www.scootersoftware.com/bcompare-4.4.6.27483_amd64.deb
        sha256: d7e7ff01fc89f19f34591e1cb352438d3aae4d1d6618050e776eef9e249e0349
        size: 20609066
      - type: extra-data
        filename: bzip2.pkg.tar.zst
        only-arches: [x86_64]
        url: https://archive.archlinux.org/packages/b/bzip2/bzip2-1.0.8-5-x86_64.pkg.tar.zst
        sha256: 4dbc8d27868674b9a3718774630be8b234beecbce16ee957239b2cb5a2e73b9f
        size: 59771
      - type: script
        dest-filename: apply_extra
        commands:
          - |
            # =====$(pwd)=====`/app/extra`=====
            # Env from `build-options` does not carry over, define vars again
            FLATPAK_ID=com.scootersoftware.BeyondCompare

            # Extract upstream package
            mkdir -p {bin,deb-package,lib} export/share/pixmaps

            bsdtar -xvf bcompare.deb
            tar -xzf data.tar.gz -C deb-package

            # Install icons
            mv deb-package/usr/share/pixmaps export/share

            # Rename all icons accordingly
            rename bcompare ${FLATPAK_ID} export/share/pixmaps/

            # Install the app
            mv deb-package/usr/bin .
            sed -i 's#BC_LIB=/usr/lib/beyondcompare#BC_LIB=/app/extra/lib/beyondcompare#' bin/bcompare
            mv deb-package/usr/lib .

            # To-do: Fix context menus
            # lib/bcompare/kde_context_menu
            # Source new version of this file from GH repo and replace existing one
            # In essence, need to share desktop files from within the Flatpak, rather than using the native script to place items in home directory ourside of Flatpak

            # Install missing dependency
            unzstd bzip2.pkg.tar.zst
            mkdir bzip2
            tar -xvf bzip2.pkg.tar -C bzip2
            cp bzip2/usr/lib/* lib/beyondcompare
            ls -la lib/beyondcompare

            # Cleanup
            rm -rf control.tar.gz data.tar.gz debian-binary deb-package bcompare.deb
      - type: file
        path: icons/com.scootersoftware.BeyondCompare.png
      - type: file
        path: com.scootersoftware.BeyondCompare.desktop
      - type: file
        path: com.scootersoftware.BeyondCompare.metainfo.xml
      - type: file
        path: com.scootersoftware.BeyondCompare.mime.xml
